/**
 * Created by mcake on 2016/5/24.
 */
(function($){
    var resData = {
        "groups":[
            {
                "keys":"qie_png,qie_dance_png,side_bear_png,text1_png,text2_png,ticket1_png,ticket2_png,top_bg_jpg,tv_png,arrow1_png,arrow2_png,arrow3_png,bear_png,bear_ugly_png,buy_btn_png,buy_btn_disabled_png,buy_btn2_png,buy_btn2_disabled_png,cake_card1_png,cateau_png,chocolate-box_png,main_bg_jpg,price1_png,price2_png",
                "name":"preload"
            }],
        "resources":[
            {
                "name":"side_bear_png",
                "type":"image",
                "url":"side_bear.png"
            },
            {
                "name":"text1_png",
                "type":"image",
                "url":"text1.png"
            },
            {
                "name":"text2_png",
                "type":"image",
                "url":"text2.png"
            },
            {
                "name":"ticket1_png",
                "type":"image",
                "url":"ticket1.png"
            },
            {
                "name":"ticket2_png",
                "type":"image",
                "url":"ticket2.png"
            },
            {
                "name":"top_bg_jpg",
                "type":"image",
                "url":"top_bg.jpg"
            },
            {
                "name":"tv_png",
                "type":"image",
                "url":"tv.png"
            },
            {
                "name":"arrow1_png",
                "type":"image",
                "url":"arrow1.png"
            },
            {
                "name":"arrow2_png",
                "type":"image",
                "url":"arrow2.png"
            },
            {
                "name":"arrow3_png",
                "type":"image",
                "url":"arrow3.png"
            },
            {
                "name":"bear_png",
                "type":"image",
                "url":"bear.png"
            },
            {
                "name":"bear_ugly_png",
                "type":"image",
                "url":"bear_ugly.png"
            },
            {
                "name":"buy_btn_png",
                "type":"image",
                "url":"buy_btn.png"
            },
            {
                "name":"buy_btn_disabled_png",
                "type":"image",
                "url":"buy_btn_disabled.png"
            },
            {
                "name":"buy_btn2_png",
                "type":"image",
                "url":"buy_btn2.png"
            },
            {
                "name":"buy_btn2_disabled_png",
                "type":"image",
                "url":"buy_btn2_disabled.png"
            },
            {
                "name":"cake_card1_png",
                "type":"image",
                "url":"cake_card1.png"
            },
            {
                "name":"cateau_png",
                "type":"image",
                "url":"cateau.png"
            },
            {
                "name":"chocolate-box_png",
                "type":"image",
                "url":"chocolate-box.png"
            },
            {
                "name":"main_bg_jpg",
                "type":"image",
                "url":"main_bg.jpg"
            },
            {
                "name":"price1_png",
                "type":"image",
                "url":"price1.png"
            },
            {
                "name":"price2_png",
                "type":"image",
                "url":"price2.png"
            },
            {
                "name":"qie_png",
                "type":"image",
                "url":"qie.png"
            },
            {
                "name":"qie_dance_png",
                "type":"image",
                "url":"qie_dance.png"
            }]
    };

    var qieMcData = {"mc":{
        "qie":{
            "frameRate":24,
            "events":[

            ],
            "frames":[

                {
                    "res":"3F15C2F5",
                    "x":3,
                    "y":28,
                    "duration":4
                },
                {
                    "res":"4CB2A03",
                    "x":9,
                    "y":28,
                    "duration":4
                },
                {
                    "res":"E789DB42",
                    "x":18,
                    "y":28,
                    "duration":4
                },
                {
                    "res":"59B27F27",
                    "x":33,
                    "y":28,
                    "duration":4
                },
                {
                    "res":"53D58AF",
                    "x":47,
                    "y":28,
                    "duration":4
                },
                {
                    "res":"71F859F6",
                    "x":47,
                    "y":28,
                    "duration":4
                },
                {
                    "res":"BC6666C7",
                    "x":47,
                    "y":3,
                    "duration":4
                },
                {
                    "res":"4BD749E",
                    "x":47,
                    "y":25,
                    "duration":4
                },
                {
                    "res":"E25C6AEA",
                    "x":40,
                    "y":28,
                    "duration":4
                },
                {
                    "res":"6D6719E3",
                    "x":32,
                    "y":28,
                    "duration":4
                },
                {
                    "res":"C2AFE1FB",
                    "x":24,
                    "y":28,
                    "duration":4
                },
                {
                    "res":"2F0177F3",
                    "x":18,
                    "y":28,
                    "duration":4
                }
            ]
        }},
        "res":{
            "2F0177F3":{"x":321,"y":0,"w":105,"h":128},
            "BC6666C7":{"x":0,"y":0,"w":105,"h":153},
            "53D58AF":{"x":0,"y":288,"w":105,"h":128},
            "71F859F6":{"x":107,"y":0,"w":105,"h":128},
            "3F15C2F5":{"x":214,"y":0,"w":105,"h":128},
            "4BD749E":{"x":0,"y":155,"w":105,"h":131},
            "4CB2A03":{"x":107,"y":130,"w":105,"h":128},
            "E789DB42":{"x":107,"y":260,"w":105,"h":128},
            "6D6719E3":{"x":214,"y":130,"w":105,"h":128},
            "E25C6AEA":{"x":321,"y":130,"w":105,"h":128},
            "59B27F27":{"x":214,"y":260,"w":105,"h":128},
            "C2AFE1FB":{"x":321,"y":260,"w":105,"h":128}
        }};

    var tvMcData = {"mc":{
        "tv":{
            "frameRate":24,
            "events":[

            ],
            "frames":[

                {
                    "res":"140C5FA",
                    "x":3,
                    "y":1,
                    "duration":2
                },
                {
                    "res":"1553BA32",
                    "x":3,
                    "y":1,
                    "duration":2
                },
                {
                    "res":"69E152E7",
                    "x":3,
                    "y":1,
                    "duration":2
                },
                {
                    "res":"1553BA32",
                    "x":3,
                    "y":1,
                    "duration":2
                },
                {
                    "res":"67B73BEF",
                    "x":3,
                    "y":1,
                    "duration":2
                },
                {
                    "res":"76912222",
                    "x":3,
                    "y":1,
                    "duration":22
                },
                {
                    "res":"6DE8E1",
                    "x":3,
                    "y":1,
                    "duration":6
                },
                {
                    "res":"D161ED5D",
                    "x":3,
                    "y":1,
                    "duration":4
                },
                {
                    "res":"D7633602",
                    "x":3,
                    "y":1,
                    "duration":4
                },
                {
                    "res":"132A26B7",
                    "x":3,
                    "y":1,
                    "duration":4
                },
                {
                    "res":"E884A99E",
                    "x":3,
                    "y":1,
                    "duration":4
                },
                {
                    "res":"F8F20ED8",
                    "x":3,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"CF7129D8",
                    "x":3,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"E291E92",
                    "x":3,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"FD4EEFD8",
                    "x":3,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"5DF699B4",
                    "x":3,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"388039CD",
                    "x":3,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"2213E2D4",
                    "x":3,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"7FFAEA26",
                    "x":3,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"F99873D4",
                    "x":3,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"840116D3",
                    "x":3,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"53B2D2EF",
                    "x":3,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"76EBD4B3",
                    "x":3,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"C3A08BB0",
                    "x":3,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"1CBE589C",
                    "x":3,
                    "y":1,
                    "duration":20
                }
            ]
        }},
        "res":{
            "76912222":{"x":0,"y":0,"w":675,"h":594},
            "840116D3":{"x":677,"y":0,"w":675,"h":594},
            "67B73BEF":{"x":1354,"y":0,"w":675,"h":594},
            "69E152E7":{"x":2031,"y":0,"w":675,"h":594},
            "E884A99E":{"x":2708,"y":0,"w":675,"h":594},
            "140C5FA":{"x":3385,"y":0,"w":675,"h":594},
            "E291E92":{"x":0,"y":596,"w":675,"h":594},
            "D7633602":{"x":0,"y":1192,"w":675,"h":594},
            "D161ED5D":{"x":0,"y":1788,"w":675,"h":594},
            "1CBE589C":{"x":0,"y":2384,"w":675,"h":594},
            "CF7129D8":{"x":0,"y":2980,"w":675,"h":594},
            "53B2D2EF":{"x":677,"y":596,"w":675,"h":594},
            "F8F20ED8":{"x":1354,"y":596,"w":675,"h":594},
            "388039CD":{"x":2031,"y":596,"w":675,"h":594},
            "5DF699B4":{"x":2708,"y":596,"w":675,"h":594},
            "76EBD4B3":{"x":3385,"y":596,"w":675,"h":594},
            "F99873D4":{"x":677,"y":1192,"w":675,"h":594},
            "1553BA32":{"x":677,"y":1788,"w":675,"h":594},
            "2213E2D4":{"x":677,"y":2384,"w":675,"h":594},
            "C3A08BB0":{"x":677,"y":2980,"w":675,"h":594},
            "6DE8E1":{"x":1354,"y":1192,"w":675,"h":594},
            "132A26B7":{"x":2031,"y":1192,"w":675,"h":594},
            "7FFAEA26":{"x":2708,"y":1192,"w":675,"h":594},
            "FD4EEFD8":{"x":3385,"y":1192,"w":675,"h":594}
        }};

    var bearMcData = {"mc":{
        "bear":{
            "frameRate":24,
            "events":[

            ],
            "frames":[

                {
                    "res":"990C19D9",
                    "x":0,
                    "y":0,
                    "duration":1
                },
                {
                    "res":"4A8A3610",
                    "x":0,
                    "y":0,
                    "duration":1
                },
                {
                    "res":"990C19D9",
                    "x":0,
                    "y":0,
                    "duration":1
                },
                {
                    "res":"4A8A3610",
                    "x":0,
                    "y":0,
                    "duration":1
                },
                {
                    "res":"990C19D9",
                    "x":0,
                    "y":0,
                    "duration":4
                },
                {
                    "res":"4A8A3610",
                    "x":0,
                    "y":0,
                    "duration":1
                },
                {
                    "res":"990C19D9",
                    "x":0,
                    "y":0,
                    "duration":1
                },
                {
                    "res":"4A8A3610",
                    "x":0,
                    "y":0,
                    "duration":1
                },
                {
                    "res":"990C19D9",
                    "x":0,
                    "y":0,
                    "duration":40
                }
            ]
        }},
        "res":{
            "990C19D9":{"x":0,"y":0,"w":353,"h":204},
            "4A8A3610":{"x":0,"y":206,"w":353,"h":204}
        }};

    var sideBearMcData = {"mc":{
        "side_bear":{
            "frameRate":24,
            "events":[

            ],
            "frames":[

                {
                    "res":"E7E137D3",
                    "x":0,
                    "y":1,
                    "duration":10
                },
                {
                    "res":"95C7EE17",
                    "x":0,
                    "y":1,
                    "duration":2
                },
                {
                    "res":"4225634D",
                    "x":0,
                    "y":1,
                    "duration":2
                },
                {
                    "res":"7763B46F",
                    "x":0,
                    "y":23,
                    "duration":6
                },
                {
                    "res":"57C0C9C9",
                    "x":0,
                    "y":23,
                    "duration":40
                }
            ]
        }},
        "res":{
            "4225634D":{"x":0,"y":0,"w":392,"h":360},
            "57C0C9C9":{"x":788,"y":0,"w":392,"h":338},
            "E7E137D3":{"x":0,"y":362,"w":392,"h":360},
            "7763B46F":{"x":394,"y":362,"w":392,"h":338},
            "95C7EE17":{"x":394,"y":0,"w":392,"h":360}
        }};

    var bearUglyMcData = {"mc":{
        "bear_ugly":{
            "frameRate":24,
            "events":[

            ],
            "frames":[

                {
                    "res":"91F8CDE4",
                    "x":0,
                    "y":0,
                    "duration":40
                },
                {
                    "res":"1247430D",
                    "x":0,
                    "y":0,
                    "duration":2
                },
                {
                    "res":"F4E627C8",
                    "x":0,
                    "y":0,
                    "duration":4
                },
                {
                    "res":"BAEF7A32",
                    "x":0,
                    "y":0,
                    "duration":2
                },
                {
                    "res":"F4E627C8",
                    "x":0,
                    "y":0,
                    "duration":4
                },
                {
                    "res":"BAEF7A32",
                    "x":0,
                    "y":0,
                    "duration":2
                },
                {
                    "res":"F4E627C8",
                    "x":0,
                    "y":0,
                    "duration":4
                },
                {
                    "res":"BAEF7A32",
                    "x":0,
                    "y":0,
                    "duration":2
                },
                {
                    "res":"F4E627C8",
                    "x":0,
                    "y":0,
                    "duration":4
                },
                {
                    "res":"BAEF7A32",
                    "x":0,
                    "y":0,
                    "duration":2
                },
                {
                    "res":"F4E627C8",
                    "x":0,
                    "y":0,
                    "duration":4
                },
                {
                    "res":"BAEF7A32",
                    "x":0,
                    "y":0,
                    "duration":4
                }
            ]
        }},
        "res":{
            "1247430D":{"x":0,"y":0,"w":566,"h":343},
            "F4E627C8":{"x":0,"y":345,"w":566,"h":343},
            "BAEF7A32":{"x":568,"y":0,"w":566,"h":343},
            "91F8CDE4":{"x":1136,"y":0,"w":566,"h":343}
        }};

    $.extend($.easing, {
        easeInCubic:function(e,f,a,h,g){
            return h*(f/=g)*f*f+a;
        },
        easeOutCubic: function(e,f,a,h,g){
            return h*((f=f/g-1)*f*f+1)+a;
        }
    });

    var aniMap = {
        "slide-left": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                marginLeft: el.offsetWidth*0.5
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    marginLeft: 0
                }, 1000, 'easeOutCubic', function(){
                    cb && cb();
                });
            }, delay);

        },
        "slide-right": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                marginLeft: -el.offsetWidth*0.5
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    marginLeft: 0
                }, 1000, 'easeOutCubic', function(){
                    cb && cb();
                });
            }, delay);

        },
        "slide-down-l": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                marginLeft: -el.offsetWidth*0.3,
                marginTop: -el.offsetHeight*0.8
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    marginLeft: 0,
                    marginTop: 0
                }, 1000, 'easeOutCubic', function(){
                    cb && cb();
                });
            }, delay);

        },
        "slide-down-r": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                marginLeft: el.offsetWidth*0.15,
                marginTop: -el.offsetHeight*0.8
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    marginLeft: 0,
                    marginTop: 0
                }, 1000, 'easeOutCubic', function(){
                    cb && cb();
                });
            }, delay);

        },
        "slide-up-l": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                marginLeft: -el.offsetWidth*0.5,
                marginTop: el.offsetHeight*0.5
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    marginLeft: 0,
                    marginTop: 0
                }, 1000, 'easeOutCubic', function(){
                    cb && cb();
                });
            }, delay);

        },
        "slide-up-r": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                marginLeft: el.offsetWidth*0.5,
                marginTop: el.offsetHeight*0.5
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    marginLeft: 0,
                    marginTop: 0
                }, 1000, 'easeOutCubic', function(){
                    cb && cb();
                });
            }, delay);

        },
        "slide-up": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                //marginRight: -el.offsetWidth*0.5,
                marginTop: el.offsetHeight*0.5
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    // marginRight: 0,
                    marginTop: 0
                }, 1000, 'easeOutCubic', cb);
            }, delay);

        },
        "fade-in": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1
                }, 800, cb);
            }, delay);
        }
    };

    var isSupportCss3 = (function(){
        var ret = /MSIE (\d+\.\d+)/.exec(navigator.userAgent);
        if( !ret || ret[1] > 9 ){
            return true;
        }
        return false;
    })();

    var setAnimate = function(el, hasDelay){
        var anim = el.getAttribute('data-anim');
        var delay = Number(el.getAttribute('data-delay')||0)*1000;
        var delayAdjust = Number(el.getAttribute('data-delay-adjust')||0)*1000;
        var chain = el.getAttribute('data-chain');

        delay = hasDelay ? delay : 0;
        delay += delayAdjust;

        if( isSupportCss3 ){
            var chainHandle = function(){
                $(chain).each(function(){
                    setAnimate(this, true);
                });
                el.removeEventListener('webkitAnimationEnd', chainHandle, false);
                el.removeEventListener('animationend', chainHandle, false);
            };

            el.className = [el.className, anim].join(" ");
            el.style['-webkit-animation-delay'] = delay + "ms";
            el.style['animationDelay'] = delay + "ms";
            if( chain ) {
                el.addEventListener('webkitAnimationEnd', chainHandle, false);
                el.addEventListener('animationend', chainHandle, false);
            }
        } else {
            if( aniMap[anim] ) {
                aniMap[anim].call(el, el, delay, function(){
                    if( chain ) {
                        $(chain).each(function(){
                            setAnimate(this, true);
                        });
                    }
                });
            }
        }
    };

    var setAllAnimate = function(container){
        $(container).find("[data-anim]").each(function(){
            setAnimate(this);
        });
    };

    var setQieMC = function(){
        var mc = new MovieClip(Resource.getRes('qie_dance_png'), qieMcData, 'qie', 'qie_dance');
        mc.gotoAndPlay(1, 1);
        mc.on('complete', function(){
            mc.gotoAndStop(1);
        })
        return mc;
    };

    var setTvMC = function(){
        var mc = new MovieClip(Resource.getRes('tv_png'), tvMcData, 'tv', 'tv_display');
        mc.gotoAndPlay(1, -1);
        return mc;
    };

    var setBearMC = function(){
        var mc = new MovieClip(Resource.getRes('bear_png'), bearMcData, 'bear', 'bear_qiuck');
        mc.gotoAndPlay(1, -1);
        return mc;
    };

    var setSideBearMC = function(){
        var mc = new MovieClip(Resource.getRes('side_bear_png'), sideBearMcData, 'side_bear', 'side_bear');
        mc.gotoAndPlay(1, -1);
        return mc;
    };

    var setBearUglyMC = function(){
        var mc = new MovieClip(Resource.getRes('bear_ugly_png'), bearUglyMcData, 'bear_ugly', 'bear_ugly');
        mc.gotoAndPlay(1, -1);
        return mc;
    };

    var bindScroll = function( container ){

        var checkOffset = 200;
        var $win = $(window);
        var winHeight = $win.height();
        var initScrollTop = $win.scrollTop();
        var elems = $(container).find('[data-anim]');
        var elemObj = [];

        elems.each(function(){
            elemObj.push({
                $elem: $(this),
                anim: this.getAttribute('data-anim'),
                scrollTop: $(this).offset().top,
                isAnimated: false
            });
        });

        $win.on('scroll', function(){
                var scrollTop = $win.scrollTop();
                var docHeight = document.documentElement.clientHeight;

                $.each(elemObj, function(i, obj){
                    if( !obj.isAnimated ) {
                        if( obj.$elem[0].getAttribute('data-ignore') ){
                            obj.isAnimated = true;
                            return;
                        }
                        if (scrollTop + docHeight - checkOffset > obj.scrollTop + initScrollTop) {
                            setAnimate(obj.$elem[0], obj.scrollTop < winHeight);
                            obj.isAnimated = true;
                        }
                    }
                });
            })
            .trigger('scroll');
    };

    var loadResource = function(){

        var loadComplete = function () {
            Resource.el('#evt_loading').style.display = "none";
            Resource.el('#evt_container').style.display = 'block';
            correctPNG($('#evt_container .evt_main').get(0));

            setTvMC();
            setBearMC();
            setSideBearMC();
            setBearUglyMC();
            setQieMC();
            bindScroll('#evt_container');
        };
        var loader = new Resource.loadGroup("preload", resData);
        var spin = Resource.el('#evt_spin');

        loader.addEvent("progress", function (loaded, total) {
            spin.innerHTML = "loading: " + Math.floor(loaded / total * 100) + "%";
        });

        loader.addEvent("complete", loadComplete);
    };

    var correctPNG = function(container){
        var arVersion = navigator.appVersion.split("MSIE");
        var version = parseFloat(arVersion[1]);
        if (version && (version >= 5.5 && version < 9) && (document.body.filters)) {
            var lee_i = 0;
            var docimgs=container.getElementsByTagName('img');
            for (var j = 0; j < docimgs.length; j++) {
                var img = docimgs[j];
                var imgName = img.src.toUpperCase();
                if (imgName.substring(imgName.length - 3, imgName.length) == "PNG" && !img.getAttribute("usemap")) {
                    lee_i++;
                    var SpanID = img.id || 'ra_png_' + lee_i.toString();
                    var imgData = new Image();
                    imgData.proData = SpanID;
                    imgData.onload = function () {
                        $("#" + this.proData).css("width", this.width + "px").css("height", this.height + "px");
                    }
                    imgData.src = img.src;
                    var imgID = "id='" + SpanID + "' ";
                    var imgClass = (img.className) ? "class='" + img.className + "' " : ""
                    var imgTitle = (img.title) ? "title='" + img.title + "' " : "title='" + img.alt + "' "
                    var imgStyle = "display:inline-block;" + img.style.cssText
                    if (img.align == "left") imgStyle = "float:left;" + imgStyle
                    if (img.align == "right") imgStyle = "float:right;" + imgStyle
                    if (img.parentElement.href) imgStyle = "cursor:hand;" + imgStyle
                    var strNewHTML = "<span " + imgID + imgClass + imgTitle
                        + " style=\"" + "width:" + img.width + "px; height:" + img.height + "px;" + imgStyle + ";"
                        + "filter:progid:DXImageTransform.Microsoft.AlphaImageLoader"
                        + "(src=\'" + img.src + "\', sizingMethod='scale');\"></span>"
                    img.outerHTML = strNewHTML;
                    j = j - 1;
                }
            }
        }
    };

    $(function(){
        loadResource();
    });

})(jQuery);