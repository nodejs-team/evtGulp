/**
 * Created by mcake on 2016/3/31.
 */

!function(t,e,r){"use strict";var i=function(){},n=Array.prototype,s=String.prototype,o=Object.prototype,a=n.slice,u=/^https?:\/\//;t.console||(t.console={log:i,error:i}),Date.now||(Date.now=function(){return+new Date}),t.JSON||function(){t.JSON={parse:function(t){return Function("return "+t)()}}}(),n.forEach||(n.forEach=function(t){for(var e=0,r=this.length;r>e;e++)!t||t(this[e],e,this)!==!1}),n.filter||(n.filter=function(t){var e=[];return this.forEach(function(r,i,n){t&&t(r,i,n)===!0&&e.push(r)}),e}),n.find||(n.find=function(t){for(var e=0,r=this.length;r>e;e++)if(t&&t(this[e],e,this)===!0)return this[e]}),n.map||(n.map=function(t){var e=[];return this.forEach(function(r,i,n){t&&e.push(t(r,i,n))}),e}),n.indexOf||(n.indexOf=function(t){for(var e=0,r=this.length;r>e;e++)if(this[e]===t)return e;return-1}),n.contains=n.includes||function(t){return this.indexOf(t)>-1},s.trim||(s.trim=function(){return this.replace(/(^\s+)|(\s+$)/g,"")}),Array.isArray||(Array.isArray=function(t){return"[object Array]"===o.toString.call(t)});var h=["webkit","moz"],c=t.requestAnimationFrame,l=t.cancelAnimationFrame;c||h.forEach(function(e){c=t[e+"RequestAnimationFrame"],l=t[e+"CancelAnimationFrame"]||t[e+"CancelRequestAnimationFrame"]}),c||(c=function(e){return t.setTimeout(e,1e3/60)}),l||(l=function(t){clearTimeout(t)});var f=function(t){for(var e,r,i=a.call(arguments,1),n=0;n<i.length;n++)for(r in e=i[n])e.hasOwnProperty(r)&&(t[r]=e[r]);return t},p=function(t,e,r){if("object"==typeof e){var i=a.call(arguments,1);return i.unshift(t.prototype),f.apply(null,i),t}var n=function(){};return n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.prototype.superClass=e.prototype,e.prototype.constructor==Object.prototype.constructor&&(e.prototype.constructor=e),f(t.prototype,r),f(t,e),t},m=function(){this._eventPool={}};m.prototype={on:function(t,e,r){var i=this._eventPool;return(i[t]||(i[t]=[])).push({fn:e,ctx:r||this}),this},addEvent:function(t,e,r){return this.on.apply(this,arguments)},once:function(t,e,r){function i(){n.off(t,i),e.apply(this,arguments)}var n=this;return i._=e,this.on(t,i,r)},off:function(t,e){var r=this._eventPool,i=r[t],n=[];return i&&e&&(n=i.filter(function(t){return t.fn!==e&&t.fn._!==e})),n.length?r[t]=n:delete r[t],this},dispatch:function(t){var e=a.call(arguments,1),r=(this._eventPool[t]||[]).slice();return r.length&&r.forEach(function(t){t.fn.apply(t.ctx,e)}),this},emit:function(){return this.dispatch.apply(this,arguments)},success:function(t){return this.on("success",t)},complete:function(t){return this.on("complete",t)},error:function(t){return this.on("error",t)},progress:function(t){return this.on("progress",t)},clear:function(){return this._eventPool={},this}};var y=function(t,e){this._currentCount=0,this._lastTime=0,this._repeatCount=e,this._waitTime=0,this.timer=null,this.delay=t,this.superClass.constructor.call(this)};p(y,m,{start:function(){var t=this;return this._lastTime=Date.now(),+function e(){t.timer=c(e),t._timerHandle()}(),this},stop:function(){if(this.timer)if(l(this.timer),this._waitTime>0){var t=this;setTimeout(function(){t.dispatch("complete"),t.reset()},this._waitTime)}else this.dispatch("complete"),this.reset();return this},wait:function(t){return this._waitTime=t,this},pause:function(t){if(this.timer&&(l(this.timer),this.dispatch("pause")),"number"==typeof t&&t>0){var e=this;setTimeout(function(){e.start()},t)}return this},setRepeatCount:function(t){return this._repeatCount=t,this},_timerHandle:function(){var t=Date.now();if(t-this._lastTime>=this.delay){if(this._repeatCount&&++this._currentCount==this._repeatCount)return void this.stop();this._lastTime=t,this.dispatch("timer",t)}this.dispatch("enterframe",t)},reset:function(){return this._currentCount=0,this.timer=null,this}});var d=function(t,r,i,n){this.el="string"==typeof n?e.getElementById(n):n,this._startFrame=0,this._startTime=0,this._playTimes=-1,this._resKey=i,this.currentFrame=0,this.isPlaying=!1,this.setRES(t,r),Array.isArray(this.RESUrl)?(this.totalFrames=this.RESUrl.length,this.setFrame=this.setFrameByPath,this.elImg=e.createElement("img"),this.el.appendChild(this.elImg)):this.setFrame=this.setFrameBySprite,this.superClass.constructor.call(this),this._timer=new y(this.frameRate,this._repeatCount),this._initEvents()};p(d,m,{getMovieClipData:function(t){return this.RES.mc[t]||[]},gotoAndPlay:function(t,e,r){return t=Math.max(0,t-1),this._startFrame=t,this._playTimes=e,this.currentFrame=t,this._playTimes>0&&(this._repeatCount=this._playTimes*this.totalFrames,this._timer.setRepeatCount(this._repeatCount)),r&&this.setFrameRate(Math.round(1e3/r)),this.setFrame(this.currentFrame),this.play(),this},gotoAndStop:function(t){return this.setFrame(t)},prevFrame:function(){return this.setFrame(--this.currentFrame)},nextFrame:function(){return this.setFrame(++this.currentFrame)},play:function(){return this.isPlaying?this:(this._startTime=Date.now(),this._timer.start(),this.isPlaying=!0,this)},stop:function(){return this._timer.stop(),this.isPlaying=!1,this},pause:function(t){return this._timer.pause(t),this._startTime+=t,this.isPlaying=!1,this},wait:function(t){return this._timer.wait(t),this},setFrameRate:function(t){this.frameRate=t},setRES:function(t,e,r){this.RESUrl=v(t),this.RES=_(e,this._resKey,this.el),this.currentFrame=0,this.frame=this.getMovieClipData(this._resKey),this.frameRate=Math.round(1e3/(this.frame.frameRate||24)),this.totalFrames=this.frame.frames.length,r&&this.setFrameRate(r)},setFrameBySprite:function(t){var e=this.frame.frames[t]||{},i=this.RES.res[e.res];return i!=r?(this._timer.delay=(e.duration||0)*this.frameRate,this.el.style.width=i.w+"px",this.el.style.height=i.h+"px",this.el.style.marginLeft=(e.x||0)+"px",this.el.style.marginTop=(e.y||0)+"px",this.el.style.background="url("+this.RESUrl+") no-repeat "+-i.x+"px "+-i.y+"px",this):void 0},setFrameByPath:function(t){var e=this.frame.frames[t]||{};return this._timer.delay=(e.duration||0)*this.frameRate,this.el.style.marginLeft=(e.x||0)+"px",this.el.style.marginTop=(e.y||0)+"px",this.elImg.src=this.RESUrl[t],this},clear:function(){return this.el.style.width="",this.el.style.height="",this.el.style.marginLeft="",this.el.style.marginTop="",this.el.style.background="",this.elImg&&(this.el.removeChild(this.elImg),delete this.elImg),this},_initEvents:function(){this._timer.on("timer",function(){++this.currentFrame>this.totalFrames-1&&(this.currentFrame=this._startFrame,this.dispatch("loopcomplete")),this.setFrame(this.currentFrame)},this),this._timer.on("enterframe",function(t){this.dispatch("enterframe",this.currentFrame,t-this._startTime)},this),this._timer.on("complete",function(){this.dispatch("complete")},this)}});var g=function(e,r){return t.getComputedStyle?t.getComputedStyle(e,null)[r]:e.currentStyle[r]},v=function(t){return/_(png|jpg|jpeg|gif|bmp|)$/.test(t)?E.getRes(t):t},_=function(t,e,i){if("string"==typeof t)return E.getRes(t);if(Array.isArray(t)){var n=[],s={},o={mc:{},res:{}},a=parseFloat(g(i,"width")),u=parseFloat(g(i,"height"));return t.forEach(function(t){var e=t.split(" "),r=F();n.push({res:r,x:0,y:0,duration:1}),s[r]={x:-1*e[0],y:-1*e[1],w:a,h:u}}),o.mc[e]={frames:n,frameRate:24},o.res=s,o}if("object"==typeof t&&!t.mc){var n=[],s={},o={mc:{},res:{}};for(var h in t){var c=t[h],l=F();n.push({res:l,key:h,x:c.offX,y:c.offY,duration:c.duration===r?1:c.duration}),s[l]={x:c.x,y:c.y,w:c.w,h:c.h}}return n=n.sort(function(t,e){return parseInt(t.key.replace(/^[^\d]+/,""))-parseInt(e.key.replace(/^[^\d]+/,""))}),o.mc[e]={frames:n,frameRate:24},o.res=s,o}return t},F=function(t){var e="",r=0;for(t=t||8;r++<t;)e+=Math.floor(16*Math.random()).toString(16);return e.toUpperCase()},E=function(){var i={},n=function(t,e,r){var i=new Image;i.onload=function(){i.onload=new Function,e&&e(i)},i.onerror=function(){i.onerror=new Function,r&&r(i),console.error("fail load:"+t)},t=u.test(t)?t:E.baseUrl+t,i.src=t},s=function(t){var e=this;this.superClass.constructor.call(this),n(t,function(t){e.dispatch("success",t)},function(t){e.dispatch("error",t)})};p(s,m);var o=function(e,r,i){var n=function(){if(t.XMLHttpRequest)return new XMLHttpRequest;try{return new ActiveXObject("Microsoft.XMLHttp")}catch(e){return null}}();if(n)return e=u.test(e)?e:E.baseUrl+e,n.open("GET",e,!0),n.onreadystatechange=function(){if(4==n.readyState)if(200==n.status)try{r&&r(JSON.parse(n.responseText))}catch(t){}else i&&i(n),console.error("fail load:"+e)},n.send(null),n},a=function(t){var e=this;this.superClass.constructor.call(this),o(t,function(t){e.dispatch("success",t)},function(t){e.dispatch("error",t)})};p(a,m);var h=function(t,e){"object"==typeof t&&("image"==t.type?n(t.url,function(){i[t.name]=t,e&&e(t)}):"json"==t.type||"sheet"==t.type?o(t.url,function(r){var s=f({},t,{data:r});if(i[t.name]=s,"sheet"==t.type){var o=t.url.replace(/\.json$/,".png"),a=t.name.replace(/_json$/,"_png");n(o,function(){var r=f({},t,{url:o,name:a,type:"image"});i[a]=r,e&&e(r)})}else e&&e(s)}):(i[t.name]=t,e&&e(t)))},c=function(){return i},l=function(t,e){var n=/\[(\d+\-\d+)\]/,s=n.exec(t);if(s){for(var o=[],a=RegExp.$1.split("-"),h=t.replace(n,"").split("_"),c=Number(a[0]);c<Number(a[1])+1;c++){var l=h[0]+c+"_"+h[1],f=u.test(i[l].url)?i[l].url:E.baseUrl+i[l].url;o.push(f)}return o}var p=i[t];return p===r?console.error(t+" does not exist!"):"json"==p.type||"sheet"==p.type?e?p.data.frames[e]:p.data:u.test(p.url)?p.url:E.baseUrl+p.url},y=function(t,r){if("string"!=typeof t)return t;if(!/^(#|\.)/.test(t))return null;var i=t.charAt(0);if(r=r||e,"#"==i)return e.getElementById(t.substr(1,t.length));if(e.querySelectorAll)return r.querySelectorAll(t);try{return r.getElementsByClassName(t)}catch(n){var s=[],o=r.getElementsByTagName("*");return o.forEach(function(e){(" "+e.className+" ").indexOf(" "+t+" ")>-1&&s.push(e)}),s}},d=function(t,e){var i=e.groups.find(function(e){return e.name==t});if(i===r)return console.error('group "'+t+'" dose not exsit!');var n=i.keys.split(",").map(function(t){return t.trim()});return n},v=function(t,e){var r=[];return t.forEach(function(t){e.indexOf(t.name)>-1&&r.push(t)}),r},_=function(t,e){var i=d(t,e);if(i!==r){var n=v(e.resources,i),s=this,o=0,a=n.length;this.superClass.constructor.call(this),setTimeout(function(){n.forEach(function(t){h(t,function(){s.dispatch("progress",++o,a,t),o>a-1&&s.dispatch("complete")})})},0)}};return p(_,m),{IMGloader:s,JSONloader:a,loadGroup:_,getAsset:c,getRes:l,getStyle:g,el:y}}();E.baseUrl="images/",t.Extend=t.Extend||f,t.CustEvent=m,t.ClassExtend=p,t.Timer=y,t.MovieClip=d,t.Resource=E}(window,window.document);