/**
 * Created by mcake on 2016/5/24.
 */
(function($){
    var resData = {
        "groups":[
            {
                "keys":"q4_png,q7_png,q8_png,q9_png,q11_png,q13_png,q14_png,q15_png,rabbit_png,sea-bench_png,sea-leaf_png,text1_png,text2_png,text4_png,text5_png,text1_cn_png,text2_cn_png,text4_cn_png,text5_cn_png,arrow1_png,arrow3_png,arrow4_png,beike_png,bubble_gif,bubble1_png,bubble2_png,bubble3_png,bubble-sm_gif,bubble-sm1_png,bubble-sm2_png,buy-btn_png,buy-btn-disabled_png,fish1_png,fish2_gif,fish3_png,fish-woman_png,pigboat_png,tkboat_png,q1_png,q2_png",
                "name":"preload"
            }],
        "resources":[
            {
                "name":"q4_png",
                "type":"image",
                "url":"q4.png"
            },
            {
                "name":"q7_png",
                "type":"image",
                "url":"q7.png"
            },
            {
                "name":"q8_png",
                "type":"image",
                "url":"q8.png"
            },
            {
                "name":"q9_png",
                "type":"image",
                "url":"q9.png"
            },
            {
                "name":"q11_png",
                "type":"image",
                "url":"q11.png"
            },
            {
                "name":"q13_png",
                "type":"image",
                "url":"q13.png"
            },
            {
                "name":"q14_png",
                "type":"image",
                "url":"q14.png"
            },
            {
                "name":"q15_png",
                "type":"image",
                "url":"q15.png"
            },
            {
                "name":"rabbit_png",
                "type":"image",
                "url":"rabbit.png"
            },
            {
                "name":"sea-bench_png",
                "type":"image",
                "url":"sea-bench.png"
            },
            {
                "name":"sea-leaf_png",
                "type":"image",
                "url":"sea-leaf.png"
            },
            {
                "name":"text1_png",
                "type":"image",
                "url":"text1.png"
            },
            {
                "name":"text2_png",
                "type":"image",
                "url":"text2.png"
            },
            {
                "name":"text4_png",
                "type":"image",
                "url":"text4.png"
            },
            {
                "name":"text5_png",
                "type":"image",
                "url":"text5.png"
            },
            {
                "name":"text1_cn_png",
                "type":"image",
                "url":"text1_cn.png"
            },
            {
                "name":"text2_cn_png",
                "type":"image",
                "url":"text2_cn.png"
            },
            {
                "name":"text4_cn_png",
                "type":"image",
                "url":"text4_cn.png"
            },
            {
                "name":"text5_cn_png",
                "type":"image",
                "url":"text5_cn.png"
            },
            {
                "name":"arrow1_png",
                "type":"image",
                "url":"arrow1.png"
            },
            {
                "name":"arrow3_png",
                "type":"image",
                "url":"arrow3.png"
            },
            {
                "name":"arrow4_png",
                "type":"image",
                "url":"arrow4.png"
            },
            {
                "name":"beike_png",
                "type":"image",
                "url":"beike.png"
            },
            {
                "name":"bubble_gif",
                "type":"image",
                "url":"bubble.gif"
            },
            {
                "name":"bubble1_png",
                "type":"image",
                "url":"bubble1.png"
            },
            {
                "name":"bubble2_png",
                "type":"image",
                "url":"bubble2.png"
            },
            {
                "name":"bubble3_png",
                "type":"image",
                "url":"bubble3.png"
            },
            {
                "name":"bubble-sm_gif",
                "type":"image",
                "url":"bubble-sm.gif"
            },
            {
                "name":"bubble-sm1_png",
                "type":"image",
                "url":"bubble-sm1.png"
            },
            {
                "name":"bubble-sm2_png",
                "type":"image",
                "url":"bubble-sm2.png"
            },
            {
                "name":"buy-btn_png",
                "type":"image",
                "url":"buy-btn.png"
            },
            {
                "name":"buy-btn-disabled_png",
                "type":"image",
                "url":"buy-btn-disabled.png"
            },
            {
                "name":"fish1_png",
                "type":"image",
                "url":"fish1.png"
            },
            {
                "name":"fish2_gif",
                "type":"image",
                "url":"fish2.gif"
            },
            {
                "name":"fish3_png",
                "type":"image",
                "url":"fish3.png"
            },
            {
                "name":"fish-woman_png",
                "type":"image",
                "url":"fish-woman.png"
            },
            {
                "name":"pigboat_png",
                "type":"image",
                "url":"pigboat.png"
            },
            {
                "name":"tkboat_png",
                "type":"image",
                "url":"tkboat.png"
            },
            {
                "name":"q1_png",
                "type":"image",
                "url":"q1.png"
            },
            {
                "name":"q2_png",
                "type":"image",
                "url":"q2.png"
            }]
    };

    var rabbitMcData = {"mc":{
        "rabbit":{
            "frameRate":24,
            "events":[

            ],
            "frames":[

                {
                    "res":"9295AB68",
                    "x":18,
                    "y":23,
                    "duration":3
                },
                {
                    "res":"4C082180",
                    "x":16,
                    "y":12,
                    "duration":3
                },
                {
                    "res":"C39C5C34",
                    "x":16,
                    "y":3,
                    "duration":3
                }
            ]
        }},
        "res":{
            "9295AB68":{"x":108,"y":151,"w":105,"h":140},
            "C39C5C34":{"x":0,"y":0,"w":106,"h":158},
            "4C082180":{"x":108,"y":0,"w":106,"h":149}
        }};

    var pigboatMcData = {"mc":{
        "pigboat":{
            "frameRate":24,
            "events":[

            ],
            "frames":[

                {
                    "res":"DE36A739",
                    "x":11,
                    "y":26,
                    "duration":5
                },
                {
                    "res":"8BCC752A",
                    "x":11,
                    "y":22,
                    "duration":5
                },
                {
                    "res":"31E5601C",
                    "x":11,
                    "y":15,
                    "duration":5
                },
                {
                    "res":"30AFFEBF",
                    "x":11,
                    "y":6,
                    "duration":5
                },
                {
                    "res":"8BD8A3A5",
                    "x":11,
                    "y":3,
                    "duration":5
                },
                {
                    "res":"1E2C7629",
                    "x":11,
                    "y":7,
                    "duration":5
                },
                {
                    "res":"31E5601C",
                    "x":11,
                    "y":15,
                    "duration":5
                },
                {
                    "res":"8BCC752A",
                    "x":11,
                    "y":22,
                    "duration":5
                }
            ]
        }},
        "res":{
            "1E2C7629":{"x":0,"y":503,"w":772,"h":497},
            "DE36A739":{"x":774,"y":991,"w":791,"h":478},
            "8BCC752A":{"x":0,"y":1002,"w":766,"h":482},
            "31E5601C":{"x":805,"y":0,"w":797,"h":489},
            "8BD8A3A5":{"x":0,"y":0,"w":803,"h":501},
            "30AFFEBF":{"x":805,"y":491,"w":772,"h":498}
        }};

    var tkboatMcData = {"mc":{
        "tkboat":{
            "frameRate":24,
            "events":[

            ],
            "frames":[

                {
                    "res":"9228B6CE",
                    "x":9,
                    "y":6,
                    "duration":5
                },
                {
                    "res":"16FF7BED",
                    "x":9,
                    "y":6,
                    "duration":5
                },
                {
                    "res":"BE64947C",
                    "x":9,
                    "y":6,
                    "duration":5
                },
                {
                    "res":"35BF5C25",
                    "x":13,
                    "y":3,
                    "duration":5
                },
                {
                    "res":"FC2947BD",
                    "x":13,
                    "y":3,
                    "duration":5
                },
                {
                    "res":"35BF5C25",
                    "x":13,
                    "y":3,
                    "duration":5
                },
                {
                    "res":"BE64947C",
                    "x":9,
                    "y":6,
                    "duration":5
                },
                {
                    "res":"16FF7BED",
                    "x":9,
                    "y":6,
                    "duration":5
                },
                {
                    "res":"9228B6CE",
                    "x":9,
                    "y":6,
                    "duration":5
                }
            ]
        }},
        "res":{
            "9228B6CE":{"x":0,"y":0,"w":790,"h":342},
            "16FF7BED":{"x":0,"y":344,"w":766,"h":327},
            "FC2947BD":{"x":792,"y":0,"w":804,"h":335},
            "35BF5C25":{"x":768,"y":657,"w":770,"h":324},
            "BE64947C":{"x":792,"y":337,"w":798,"h":318}
        }};

    var fishWomanMcData = {"mc":{
        "fishwoman":{
            "frameRate":24,
            "events":[

            ],
            "frames":[

                {
                    "res":"40936D46",
                    "x":0,
                    "y":2,
                    "duration":40
                },
                {
                    "res":"C78F1703",
                    "x":0,
                    "y":0,
                    "duration":1
                }
            ]
        }},
        "res":{
            "40936D46":{"x":0,"y":150,"w":266,"h":146},
            "C78F1703":{"x":0,"y":0,"w":263,"h":148}
        }};

    var seaLeafMcData = {"mc":{
        "sea-leaf":{
            "frameRate":24,
            "events":[

            ],
            "frames":[

                {
                    "res":"DAAEFBA2",
                    "x":21,
                    "y":31,
                    "duration":8
                },
                {
                    "res":"3069CA81",
                    "x":17,
                    "y":30,
                    "duration":8
                },
                {
                    "res":"4A121D82",
                    "x":24,
                    "y":19
                }
            ]
        }},
        "res":{
            "DAAEFBA2":{"x":102,"y":156,"w":104,"h":154},
            "3069CA81":{"x":102,"y":0,"w":107,"h":154},
            "4A121D82":{"x":0,"y":0,"w":100,"h":165}
        }};

    var beikeMcData = {"mc":{
        "beike":{
            "frameRate":24,
            "events":[

            ],
            "frames":[

                {
                    "res":"F9A571CC",
                    "x":24,
                    "y":17,
                    "duration":20
                },
                {
                    "res":"3F36F959",
                    "x":24,
                    "y":24,
                    "duration":4
                },
                {
                    "res":"7B4DB033",
                    "x":24,
                    "y":35,
                    "duration":4
                },
                {
                    "res":"3F36F959",
                    "x":24,
                    "y":24,
                    "duration":4
                }
            ]
        }},
        "res":{
            "3F36F959":{"x":0,"y":123,"w":169,"h":114},
            "F9A571CC":{"x":0,"y":0,"w":169,"h":121},
            "7B4DB033":{"x":171,"y":0,"w":169,"h":103}
        }};

    $.extend($.easing, {
        easeInCubic:function(e,f,a,h,g){
            return h*(f/=g)*f*f+a;
        },
        easeOutCubic: function(e,f,a,h,g){
            return h*((f=f/g-1)*f*f+1)+a;
        }
    });

    var aniMap = {
        "slide-left": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                marginLeft: el.offsetWidth*0.5
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    marginLeft: 0
                }, 1000, 'easeOutCubic', function(){
                    cb && cb();
                });
            }, delay);

        },
        "slide-right": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                marginLeft: -el.offsetWidth*0.5
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    marginLeft: 0
                }, 1000, 'easeOutCubic', function(){
                    cb && cb();
                });
            }, delay);

        },
        "slide-down-l": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                marginLeft: -el.offsetWidth*0.3,
                marginTop: -el.offsetHeight*0.8
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    marginLeft: 0,
                    marginTop: 0
                }, 1000, 'easeOutCubic', function(){
                    cb && cb();
                });
            }, delay);

        },
        "slide-down-r": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                marginLeft: el.offsetWidth*0.15,
                marginTop: -el.offsetHeight*0.8
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    marginLeft: 0,
                    marginTop: 0
                }, 1000, 'easeOutCubic', function(){
                    cb && cb();
                });
            }, delay);

        },
        "slide-up-l": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                marginLeft: -el.offsetWidth*0.5,
                marginTop: el.offsetHeight*0.5
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    marginLeft: 0,
                    marginTop: 0
                }, 1000, 'easeOutCubic', function(){
                    cb && cb();
                });
            }, delay);

        },
        "slide-up-r": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                marginLeft: el.offsetWidth*0.5,
                marginTop: el.offsetHeight*0.5
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    marginLeft: 0,
                    marginTop: 0
                }, 1000, 'easeOutCubic', function(){
                    cb && cb();
                });
            }, delay);

        },
        "slide-up": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0,
                //marginRight: -el.offsetWidth*0.5,
                marginTop: el.offsetHeight*0.5
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1,
                    // marginRight: 0,
                    marginTop: 0
                }, 1000, 'easeOutCubic', cb);
            }, delay);

        },
        "fade-in": function(el, delay, cb){
            var $el = $(el);
            $el.css({
                opacity: 0
            });

            setTimeout(function(){
                $el.animate({
                    opacity: 1
                }, 800, cb);
            }, delay);
        }
    };

    var isSupportCss3 = (function(){
        var ret = /MSIE (\d+\.\d+)/.exec(navigator.userAgent);
        if( !ret || ret[1] > 9 ){
            return true;
        }
        return false;
    })();

    var setAnimate = function(el, hasDelay){
        var anim = el.getAttribute('data-anim');
        var delay = Number(el.getAttribute('data-delay')||0)*1000;
        var delayAdjust = Number(el.getAttribute('data-delay-adjust')||0)*1000;
        var chain = el.getAttribute('data-chain');

        delay = hasDelay ? delay : 0;
        delay += delayAdjust;

        var chainHandle = function(){
            $(chain).each(function(){
                setAnimate(this);
            });
            el.removeEventListener('webkitAnimationEnd', chainHandle, false);
            el.removeEventListener('animationend', chainHandle, false);
        };

        if( isSupportCss3 ){
            el.className = [el.className, anim].join(" ");
            el.style['-webkit-animation-delay'] = delay + "ms";
            el.style['animationDelay'] = delay + "ms";
            if( chain ) {
                el.addEventListener('webkitAnimationEnd', chainHandle, false);
                el.addEventListener('animationend', chainHandle, false);
            }
        } else {
            if( aniMap[anim] ) {
                aniMap[anim].call(el, el, delay, function(){
                    chain && setAnimate($(chain).get(0));
                });
            }
        }
    };

    var setAllAnimate = function(container){
        $(container).find("[data-anim]").each(function(){
            setAnimate(this);
        });
    };

    var setRabbitMC = function(){
        var mc = new MovieClip(Resource.getRes('rabbit_png'), rabbitMcData, 'rabbit', 'rabbit');
        mc.gotoAndPlay(1, -1);
        return mc;
    };

    var setPigBoatMC = function(){
        var mc = new MovieClip(Resource.getRes('pigboat_png'), pigboatMcData, 'pigboat', 'pigboat');
        mc.gotoAndPlay(1, -1);
        return mc;
    };

    var setTkboatMC = function(){
        var mc = new MovieClip(Resource.getRes('tkboat_png'), tkboatMcData, 'tkboat', 'tkboat');
        mc.gotoAndPlay(1, -1);
        return mc;
    };

    var setFishWomanMC = function(){
        var mc = new MovieClip(Resource.getRes('fish-woman_png'), fishWomanMcData, 'fishwoman', 'fish-woman');
        mc.gotoAndPlay(1, -1);
        return mc;
    };

    var setBeikeMC = function(){
        var mc = new MovieClip(Resource.getRes('beike_png'), beikeMcData, 'beike', 'beike');
        mc.gotoAndPlay(1, -1);
        return mc;
    };

    var setSeaLeafMC = function(){
        var mc = new MovieClip(Resource.getRes('sea-leaf_png'), seaLeafMcData, 'sea-leaf', 'sea-leaf');
        mc.gotoAndPlay(1, -1);
        return mc;
    };

    var bindScroll = function( container ){

        var checkOffset = 0;
        var $win = $(window);
        var winHeight = $win.height();
        var initScrollTop = $win.scrollTop();
        var elems = $(container).find('[data-anim]');
        var elemObj = [];

        elems.each(function(){
            elemObj.push({
                $elem: $(this),
                anim: this.getAttribute('data-anim'),
                scrollTop: $(this).offset().top,
                isAnimated: false
            });
        });

        $win.on('scroll', function(){
                var scrollTop = $win.scrollTop();
                var docHeight = document.documentElement.clientHeight;

                $.each(elemObj, function(i, obj){
                    if( !obj.isAnimated ) {
                        if( obj.$elem[0].getAttribute('data-ignore') ){
                            obj.isAnimated = true;
                            return;
                        }
                        if (scrollTop + docHeight - checkOffset > obj.scrollTop + initScrollTop) {
                            setAnimate(obj.$elem[0], obj.scrollTop < winHeight);
                            obj.isAnimated = true;
                        }
                    }
                });
            })
            .trigger('scroll');
    };

    var loadResource = function(){

        var loadComplete = function () {
            Resource.el('#evt_loading').style.display = "none";
            Resource.el('#evt_container').style.display = 'block';
            correctPNG(Resource.el('#evt_container'));
            if( __isMain ) {
                setPigBoatMC();
            } else {
                setTkboatMC();
            }
            try {
                setRabbitMC();
                setFishWomanMC();
                setSeaLeafMC();
                setBeikeMC();
            }catch (e){}
            bindScroll('#evt_container');
        };
        var loader = new Resource.loadGroup("preload", resData);
        var spin = Resource.el('#evt_spin');

        loader.addEvent("progress", function (loaded, total) {
            spin.innerHTML = "loading: " + Math.floor(loaded / total * 100) + "%";
        });

        loader.addEvent("complete", loadComplete);
    };

    var correctPNG = function(container){
        var arVersion = navigator.appVersion.split("MSIE");
        var version = parseFloat(arVersion[1]);
        if (version && (version >= 5.5 && version < 9) && (document.body.filters)) {
            var lee_i = 0;
            var docimgs=container.getElementsByTagName('img');
            for (var j = 0; j < docimgs.length; j++) {
                var img = docimgs[j];
                var imgName = img.src.toUpperCase();
                if (imgName.substring(imgName.length - 3, imgName.length) == "PNG" && !img.getAttribute("usemap")) {
                    lee_i++;
                    var SpanID = img.id || 'ra_png_' + lee_i.toString();
                    var imgData = new Image();
                    imgData.proData = SpanID;
                    imgData.onload = function () {
                        $("#" + this.proData).css("width", this.width + "px").css("height", this.height + "px");
                    }
                    imgData.src = img.src;
                    var imgID = "id='" + SpanID + "' ";
                    var imgClass = (img.className) ? "class='" + img.className + "' " : ""
                    var imgTitle = (img.title) ? "title='" + img.title + "' " : "title='" + img.alt + "' "
                    var imgStyle = "display:inline-block;" + img.style.cssText
                    if (img.align == "left") imgStyle = "float:left;" + imgStyle
                    if (img.align == "right") imgStyle = "float:right;" + imgStyle
                    if (img.parentElement.href) imgStyle = "cursor:hand;" + imgStyle
                    var strNewHTML = "<span " + imgID + imgClass + imgTitle
                        + " style=\"" + "width:" + img.width + "px; height:" + img.height + "px;" + imgStyle + ";"
                        + "filter:progid:DXImageTransform.Microsoft.AlphaImageLoader"
                        + "(src=\'" + img.src + "\', sizingMethod='scale');\"></span>"
                    img.outerHTML = strNewHTML;
                    j = j - 1;
                }
            }
        }
    };

    $(function(){
        loadResource();
    });

})(jQuery);